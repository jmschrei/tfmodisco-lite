import random
import h5py
import numpy as np
from click.testing import CliRunner
from modiscolite.cli import motifs
from conftest import data_ohe_hyps


def test_modisco_motif(data_ohe_hyps, tmp_path):
    random.seed(42)
    np.random.seed(42)

    ohe, hyps = data_ohe_hyps
    output = tmp_path / "modisco_results.h5"

    runner = CliRunner()
    result = runner.invoke(motifs, ["-s", ohe, "-a", hyps, "-n", 2000, "-o", output, '-w', 200, '-v'])
    assert result.exit_code == 0

    with h5py.File(output, "r") as f:
        assert list(f['pos_patterns'].keys()) == ['pattern_0', 'pattern_1', 'pattern_2']

        np.testing.assert_allclose(f['pos_patterns']['pattern_0']['sequence'][:], np.array([
            [0.29230769, 0.32307692, 0.16923077, 0.21538462],
            [0.26153846, 0.21538462, 0.21538462, 0.30769231],
            [0.24615385, 0.29230769, 0.15384615, 0.30769231],
            [0.24615385, 0.27692308, 0.29230769, 0.18461538],
            [0.23076923, 0.24615385, 0.2       , 0.32307692],
            [0.26153846, 0.24615385, 0.30769231, 0.18461538],
            [0.26153846, 0.27692308, 0.23076923, 0.23076923],
            [0.35384615, 0.18461538, 0.23076923, 0.23076923],
            [0.30769231, 0.21538462, 0.26153846, 0.21538462],
            [0.32307692, 0.27692308, 0.21538462, 0.18461538],
            [0.24615385, 0.09230769, 0.4       , 0.26153846],
            [0.10769231, 0.87692308, 0.01538462, 0.        ],
            [0.4       , 0.24615385, 0.07692308, 0.27692308],
            [0.        , 1.        , 0.        , 0.        ],
            [0.92307692, 0.04615385, 0.        , 0.03076923],
            [0.01538462, 0.03076923, 0.95384615, 0.        ],
            [0.        , 0.93846154, 0.        , 0.06153846],
            [0.72307692, 0.01538462, 0.09230769, 0.16923077],
            [0.01538462, 0.        , 0.89230769, 0.09230769],
            [0.        , 0.01538462, 0.96923077, 0.01538462],
            [0.44615385, 0.12307692, 0.23076923, 0.2       ],
            [0.33846154, 0.09230769, 0.41538462, 0.15384615],
            [0.29230769, 0.2       , 0.33846154, 0.16923077],
            [0.09230769, 0.33846154, 0.26153846, 0.30769231],
            [0.29230769, 0.27692308, 0.15384615, 0.27692308],
            [0.30769231, 0.24615385, 0.26153846, 0.18461538],
            [0.32307692, 0.16923077, 0.30769231, 0.2       ],
            [0.23076923, 0.18461538, 0.27692308, 0.30769231],
            [0.35384615, 0.21538462, 0.26153846, 0.16923077],
            [0.29230769, 0.15384615, 0.33846154, 0.21538462],
            [0.24615385, 0.18461538, 0.33846154, 0.23076923],
            [0.15384615, 0.30769231, 0.29230769, 0.24615385],
            [0.27692308, 0.30769231, 0.24615385, 0.16923077],
            [0.29230769, 0.21538462, 0.23076923, 0.26153846],
            [0.30769231, 0.13846154, 0.24615385, 0.30769231],
            [0.38461538, 0.18461538, 0.26153846, 0.16923077],
            [0.38461538, 0.15384615, 0.2       , 0.26153846],
            [0.26153846, 0.21538462, 0.24615385, 0.27692308],
            [0.23076923, 0.23076923, 0.26153846, 0.27692308],
            [0.12307692, 0.26153846, 0.41538462, 0.2       ],
            [0.36923077, 0.18461538, 0.29230769, 0.15384615],
            [0.2       , 0.18461538, 0.30769231, 0.30769231],
            [0.29230769, 0.24615385, 0.26153846, 0.2       ],
            [0.27692308, 0.26153846, 0.33846154, 0.12307692],
            [0.38461538, 0.16923077, 0.24615385, 0.2       ],
            [0.26153846, 0.33846154, 0.18461538, 0.21538462],
            [0.47692308, 0.16923077, 0.10769231, 0.24615385],
            [0.23076923, 0.27692308, 0.24615385, 0.24615385],
            [0.21538462, 0.15384615, 0.32307692, 0.30769231],
            [0.21538462, 0.21538462, 0.36923077, 0.2       ]
        ]), atol=1e-3, rtol=1e-3)

        np.testing.assert_allclose(f['pos_patterns']['pattern_1']['sequence'][:], np.array([
            [0.29268293, 0.31707317, 0.17073171, 0.2195122 ],
            [0.2195122 , 0.17073171, 0.2195122 , 0.3902439 ],
            [0.17073171, 0.31707317, 0.17073171, 0.34146341],
            [0.24390244, 0.31707317, 0.14634146, 0.29268293],
            [0.29268293, 0.17073171, 0.2195122 , 0.31707317],
            [0.2195122 , 0.2195122 , 0.36585366, 0.19512195],
            [0.24390244, 0.2195122 , 0.29268293, 0.24390244],
            [0.34146341, 0.17073171, 0.2195122 , 0.26829268],
            [0.34146341, 0.19512195, 0.2195122 , 0.24390244],
            [0.24390244, 0.24390244, 0.31707317, 0.19512195],
            [0.19512195, 0.26829268, 0.26829268, 0.26829268],
            [0.14634146, 0.41463415, 0.26829268, 0.17073171],
            [0.29268293, 0.34146341, 0.12195122, 0.24390244],
            [0.34146341, 0.2195122 , 0.19512195, 0.24390244],
            [0.29268293, 0.2195122 , 0.19512195, 0.29268293],
            [0.17073171, 0.2195122 , 0.17073171, 0.43902439],
            [0.14634146, 0.31707317, 0.2195122 , 0.31707317],
            [0.14634146, 0.09756098, 0.17073171, 0.58536585],
            [0.19512195, 0.19512195, 0.53658537, 0.07317073],
            [0.41463415, 0.29268293, 0.2195122 , 0.07317073],
            [0.68292683, 0.07317073, 0.14634146, 0.09756098],
            [0.29268293, 0.02439024, 0.2195122 , 0.46341463],
            [0.73170732, 0.09756098, 0.17073171, 0.        ],
            [0.97560976, 0.        , 0.        , 0.02439024],
            [0.        , 0.92682927, 0.04878049, 0.02439024],
            [1.        , 0.        , 0.        , 0.        ],
            [1.        , 0.        , 0.        , 0.        ],
            [0.56097561, 0.        , 0.        , 0.43902439],
            [0.2195122 , 0.        , 0.75609756, 0.02439024],
            [0.19512195, 0.14634146, 0.65853659, 0.        ],
            [0.3902439 , 0.24390244, 0.31707317, 0.04878049],
            [0.31707317, 0.36585366, 0.12195122, 0.19512195],
            [0.19512195, 0.29268293, 0.19512195, 0.31707317],
            [0.24390244, 0.36585366, 0.14634146, 0.24390244],
            [0.24390244, 0.41463415, 0.17073171, 0.17073171],
            [0.36585366, 0.26829268, 0.14634146, 0.2195122 ],
            [0.2195122 , 0.19512195, 0.17073171, 0.41463415],
            [0.29268293, 0.12195122, 0.24390244, 0.34146341],
            [0.26829268, 0.31707317, 0.24390244, 0.17073171],
            [0.26829268, 0.31707317, 0.2195122 , 0.19512195],
            [0.2195122 , 0.19512195, 0.29268293, 0.29268293],
            [0.14634146, 0.36585366, 0.2195122 , 0.26829268],
            [0.26829268, 0.26829268, 0.24390244, 0.2195122 ],
            [0.17073171, 0.2195122 , 0.26829268, 0.34146341],
            [0.17073171, 0.17073171, 0.29268293, 0.36585366],
            [0.19512195, 0.36585366, 0.2195122 , 0.2195122 ],
            [0.34146341, 0.09756098, 0.2195122 , 0.34146341],
            [0.41463415, 0.2195122 , 0.14634146, 0.2195122 ],
            [0.24390244, 0.31707317, 0.26829268, 0.17073171],
            [0.19512195, 0.19512195, 0.2195122 , 0.3902439 ]
        ]), atol=1e-3, rtol=1e-3)

        np.testing.assert_allclose(f['pos_patterns']['pattern_2']['sequence'], np.array([
            [0.125  , 0.34375, 0.28125, 0.25   ],
            [0.25   , 0.3125 , 0.15625, 0.28125],
            [0.25   , 0.28125, 0.34375, 0.125  ],
            [0.15625, 0.28125, 0.1875 , 0.375  ],
            [0.21875, 0.1875 , 0.28125, 0.3125 ],
            [0.375  , 0.125  , 0.28125, 0.21875],
            [0.21875, 0.21875, 0.375  , 0.1875 ],
            [0.3125 , 0.21875, 0.21875, 0.25   ],
            [0.25   , 0.25   , 0.375  , 0.125  ],
            [0.34375, 0.25   , 0.3125 , 0.09375],
            [0.28125, 0.40625, 0.21875, 0.09375],
            [0.21875, 0.21875, 0.34375, 0.21875],
            [0.21875, 0.28125, 0.09375, 0.40625],
            [0.125  , 0.6875 , 0.15625, 0.03125],
            [0.90625, 0.0625 , 0.     , 0.03125],
            [0.     , 0.     , 0.     , 1.     ],
            [0.03125, 0.21875, 0.     , 0.75   ],
            [0.53125, 0.     , 0.03125, 0.4375 ],
            [0.1875 , 0.     , 0.75   , 0.0625 ],
            [0.03125, 0.96875, 0.     , 0.     ],
            [1.     , 0.     , 0.     , 0.     ],
            [0.09375, 0.0625 , 0.     , 0.84375],
            [0.46875, 0.125  , 0.15625, 0.25   ],
            [0.375  , 0.125  , 0.     , 0.5    ],
            [0.1875 , 0.4375 , 0.25   , 0.125  ],
            [0.84375, 0.03125, 0.0625 , 0.0625 ],
            [0.875  , 0.03125, 0.0625 , 0.03125],
            [0.5    , 0.0625 , 0.03125, 0.40625],
            [0.25   , 0.125  , 0.5    , 0.125  ],
            [0.53125, 0.0625 , 0.3125 , 0.09375],
            [0.25   , 0.21875, 0.34375, 0.1875 ],
            [0.28125, 0.3125 , 0.21875, 0.1875 ],
            [0.25   , 0.34375, 0.21875, 0.1875 ],
            [0.25   , 0.375  , 0.09375, 0.28125],
            [0.125  , 0.34375, 0.25   , 0.28125],
            [0.375  , 0.21875, 0.15625, 0.25   ],
            [0.3125 , 0.21875, 0.21875, 0.25   ],
            [0.21875, 0.28125, 0.125  , 0.375  ],
            [0.21875, 0.125  , 0.53125, 0.125  ],
            [0.375  , 0.15625, 0.3125 , 0.15625],
            [0.28125, 0.25   , 0.21875, 0.25   ],
            [0.21875, 0.25   , 0.34375, 0.1875 ],
            [0.25   , 0.15625, 0.28125, 0.3125 ],
            [0.125  , 0.25   , 0.21875, 0.40625],
            [0.21875, 0.28125, 0.28125, 0.21875],
            [0.15625, 0.28125, 0.21875, 0.34375],
            [0.28125, 0.28125, 0.21875, 0.21875],
            [0.3125 , 0.0625 , 0.34375, 0.28125],
            [0.4375 , 0.21875, 0.09375, 0.25   ],
            [0.125  , 0.28125, 0.3125 , 0.28125]
        ]), atol=1e-3, rtol=1e-3)